# Deploy to GitHub Pages with Build History
name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - claude/design-regency-xpress-site-b8R1a
      - 2025-12-24/21-24-50design-webpage-for-regency-xpresscodex
      - 2025-12-24/22-31-16design-webpage-for-regency-xpresscodex
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Install dependencies
        run: npm ci

      - name: Get timestamp and info
        id: info
        run: |
          echo "timestamp=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
          echo "date_display=$(date +'%B %d, %Y at %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "commit_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_msg=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Build with timestamped base
        run: |
          # Build with timestamped subdirectory
          TIMESTAMP="${{ steps.info.outputs.timestamp }}"

          # Update vite.config.ts base path using node
          node -e "
            const fs = require('fs');
            let config = fs.readFileSync('vite.config.ts', 'utf8');
            config = config.replace(
              \"base: '/Regency-xpress/'\",
              \"base: '/Regency-xpress/builds/${TIMESTAMP}/'\"
            );
            fs.writeFileSync('vite.config.ts', config);
          "

          npm run build

          # Move build to timestamped folder
          mkdir -p deploy/builds/${TIMESTAMP}
          mv dist/* deploy/builds/${TIMESTAMP}/

      - name: Download existing builds
        continue-on-error: true
        run: |
          # Try to fetch existing gh-pages content
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          if git show gh-pages:builds 2>/dev/null; then
            git checkout gh-pages -- builds/ 2>/dev/null || true
            # Merge existing builds with new deploy folder
            if [ -d "builds" ]; then
              cp -r builds/* deploy/builds/ 2>/dev/null || true
            fi
          fi

      - name: Generate index page
        run: |
          cat > deploy/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Regency Xpress - Build Index</title>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #0A0A0B 0%, #0B1221 50%, #0A0A0B 100%);
                min-height: 100vh;
                color: #fff;
                padding: 40px 20px;
              }
              .container {
                max-width: 1000px;
                margin: 0 auto;
              }
              .header {
                text-align: center;
                margin-bottom: 60px;
                padding-bottom: 40px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
              }
              .logo {
                max-width: 200px;
                margin-bottom: 20px;
              }
              h1 {
                font-family: 'Syne', sans-serif;
                font-size: 3rem;
                font-weight: 800;
                margin-bottom: 10px;
                background: linear-gradient(135deg, #CFB53B 0%, #f4e5a3 50%, #CFB53B 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
              }
              .subtitle {
                color: rgba(255,255,255,0.5);
                font-size: 1.1rem;
              }
              .builds-grid {
                display: grid;
                gap: 20px;
              }
              .build-card {
                background: rgba(15, 15, 17, 0.6);
                backdrop-filter: blur(16px);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 12px;
                padding: 24px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: all 0.3s ease;
              }
              .build-card:hover {
                border-color: rgba(207, 181, 59, 0.3);
                box-shadow: 0 0 40px rgba(207, 181, 59, 0.1);
                transform: translateY(-2px);
              }
              .build-card.latest {
                border-color: rgba(207, 181, 59, 0.4);
                background: rgba(207, 181, 59, 0.05);
              }
              .build-info h3 {
                font-family: 'Syne', sans-serif;
                font-size: 1.3rem;
                margin-bottom: 8px;
                color: #fff;
              }
              .build-meta {
                display: flex;
                gap: 20px;
                flex-wrap: wrap;
              }
              .build-meta span {
                color: rgba(255,255,255,0.5);
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 6px;
              }
              .build-meta .branch {
                color: #4FC3F7;
              }
              .build-meta .commit {
                color: #CFB53B;
                font-family: monospace;
              }
              .badge {
                background: linear-gradient(135deg, #CFB53B, #d4c247);
                color: #0A0A0B;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                margin-left: 10px;
              }
              .view-btn {
                background: linear-gradient(135deg, #2B5091, #3d6bb8);
                color: #fff;
                padding: 12px 24px;
                border-radius: 8px;
                text-decoration: none;
                font-weight: 600;
                font-size: 0.9rem;
                transition: all 0.3s ease;
                white-space: nowrap;
              }
              .view-btn:hover {
                box-shadow: 0 0 30px rgba(43, 80, 145, 0.4);
                transform: scale(1.02);
              }
              .empty-state {
                text-align: center;
                padding: 60px;
                color: rgba(255,255,255,0.4);
              }
              .footer {
                text-align: center;
                margin-top: 60px;
                padding-top: 40px;
                border-top: 1px solid rgba(255,255,255,0.1);
                color: rgba(255,255,255,0.3);
                font-size: 0.85rem;
              }
              @media (max-width: 640px) {
                .build-card {
                  flex-direction: column;
                  gap: 20px;
                  text-align: center;
                }
                .build-meta {
                  justify-content: center;
                }
                h1 { font-size: 2rem; }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <img src="https://raw.githubusercontent.com/Domusgpt/Regency-xpress/main/logo.png" alt="Regency Xpress" class="logo">
                <h1>Build Index</h1>
                <p class="subtitle">All deployed versions of Regency Xpress Services</p>
              </div>

              <div class="builds-grid" id="builds">
                <!-- Builds will be inserted here -->
              </div>

              <div class="footer">
                <p>&copy; 2024 Regency Xpress Services. Automated deployments via GitHub Actions.</p>
              </div>
            </div>

            <script>
              // Build data will be injected here
              const builds = BUILD_DATA_PLACEHOLDER;

              const container = document.getElementById('builds');

              if (builds.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No builds available yet.</p></div>';
              } else {
                builds.forEach((build, index) => {
                  const isLatest = index === 0;
                  container.innerHTML += `
                    <div class="build-card ${isLatest ? 'latest' : ''}">
                      <div class="build-info">
                        <h3>${build.date}${isLatest ? '<span class="badge">Latest</span>' : ''}</h3>
                        <div class="build-meta">
                          <span class="branch">Branch: ${build.branch}</span>
                          <span class="commit">Commit: ${build.commit}</span>
                          <span>Build: ${build.timestamp}</span>
                        </div>
                      </div>
                      <a href="./builds/${build.timestamp}/" class="view-btn">View Build â†’</a>
                    </div>
                  `;
                });
              }
            </script>
          </body>
          </html>
          HTMLEOF

      - name: Update builds manifest
        run: |
          TIMESTAMP="${{ steps.info.outputs.timestamp }}"
          DATE_DISPLAY="${{ steps.info.outputs.date_display }}"
          COMMIT="${{ steps.info.outputs.commit_short }}"
          BRANCH="${{ steps.info.outputs.branch }}"

          # Create or update manifest
          MANIFEST_FILE="deploy/builds/manifest.json"

          if [ -f "$MANIFEST_FILE" ]; then
            # Add new build to existing manifest
            jq --arg ts "$TIMESTAMP" \
               --arg date "$DATE_DISPLAY" \
               --arg commit "$COMMIT" \
               --arg branch "$BRANCH" \
               '. + [{"timestamp": $ts, "date": $date, "commit": $commit, "branch": $branch}]' \
               "$MANIFEST_FILE" > temp.json && mv temp.json "$MANIFEST_FILE"
          else
            # Create new manifest
            echo "[{\"timestamp\": \"$TIMESTAMP\", \"date\": \"$DATE_DISPLAY\", \"commit\": \"$COMMIT\", \"branch\": \"$BRANCH\"}]" > "$MANIFEST_FILE"
          fi

          # Sort by timestamp descending and keep last 20 builds
          jq 'sort_by(.timestamp) | reverse | .[0:20]' "$MANIFEST_FILE" > temp.json && mv temp.json "$MANIFEST_FILE"

          # Inject build data into index.html using node (safer for JSON)
          node -e "
            const fs = require('fs');
            const buildData = fs.readFileSync('deploy/builds/manifest.json', 'utf8');
            let html = fs.readFileSync('deploy/index.html', 'utf8');
            html = html.replace('BUILD_DATA_PLACEHOLDER', buildData);
            fs.writeFileSync('deploy/index.html', html);
          "

      - name: Cleanup old builds
        run: |
          cd deploy/builds
          # Keep only the builds listed in manifest
          KEEP_BUILDS=$(jq -r '.[].timestamp' manifest.json)
          for dir in */; do
            dir_name="${dir%/}"
            if [ "$dir_name" != "manifest.json" ] && ! echo "$KEEP_BUILDS" | grep -q "^${dir_name}$"; then
              echo "Removing old build: $dir_name"
              rm -rf "$dir_name"
            fi
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./deploy

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
